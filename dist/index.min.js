/*!
 * Vue3-Lazyload.js v0.3.8
 * A Vue3.x image lazyload plugin
 * (c) 2024 MuRong <admin@imuboy.cn>
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vue")):"function"==typeof define&&define.amd?define(["exports","vue"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).VueLazyload={},e.vue)}(this,function(e,i){"use strict";var s,t;(t=s=s||{}).LOADING="loading",t.LOADED="loaded",t.ERROR="error";const r="undefined"!=typeof window&&null!==window,l=function(){if(r&&"IntersectionObserver"in window&&"IntersectionObserverEntry"in window&&"intersectionRatio"in window.IntersectionObserverEntry.prototype)return"isIntersecting"in window.IntersectionObserverEntry.prototype||Object.defineProperty(window.IntersectionObserverEntry.prototype,"isIntersecting",{get(){return 0<this.intersectionRatio}}),!0;return!1}(),u=Object.prototype.propertyIsEnumerable,d=Object.getOwnPropertySymbols;function g(e){return"function"==typeof e||"[object Object]"===toString.call(e)}function b(e,...t){let r=0;var o,i;for(e=(e=("object"==typeof(o=e)?null===o:"function"!=typeof o)?t[r++]:e)||{};r<t.length;r++)if(g(t[r])){for(const l of Object.keys(t[r]))"__proto__"!==(i=l)&&"constructor"!==i&&"prototype"!==i&&(g(e[l])&&g(t[r][l])?b(e[l],t[r][l]):e[l]=t[r][l]);s=n=void 0;var n=e,s=[t[r]];if(!g(n))throw new TypeError("expected the first argument to be an object");if(0!==s.length&&"function"==typeof Symbol&&"function"==typeof d)for(const a of s)for(const c of d(a))u.call(a,c)&&(n[c]=a[c])}}const a="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",o={rootMargin:"0px",threshold:0},c="data-lazy-timeout-id";class n{constructor(e){this.attempt=0,this.options={loading:a,error:"",observerOptions:o,log:!0,lifecycle:{},logLevel:"error",attempt:3},this._images=new WeakMap,this.config(e)}config(e={}){b(this.options,e)}mount(e,t){var r,o,i,n;e&&({src:t,loading:r,error:o,lifecycle:i,delay:n}=this._valueFormatter("string"==typeof t?t:t.value),this._lifecycle(s.LOADING,i,e),e.setAttribute("src",r||a),l||(this.loadImages(e,t,o,i),this._log(()=>{this._logger("Not support IntersectionObserver!")})),this._initIntersectionObserver(e,t,o,i,n))}update(e,t){var r,o,i;e&&(null!=(r=this._realObserver(e))&&r.unobserve(e),{src:r,error:t,lifecycle:o,delay:i}=this._valueFormatter("string"==typeof t?t:t.value),this._initIntersectionObserver(e,r,t,o,i))}unmount(e){var t;e&&(null!=(t=this._realObserver(e))&&t.unobserve(e),this._images.delete(e))}loadImages(e,t,r,o){this._setImageSrc(e,t,r,o)}_setImageSrc(t,r,o,i){"img"===t.tagName.toLowerCase()?(r&&t.getAttribute("src")!==r&&t.setAttribute("src",r),this._listenImageStatus(t,()=>{this.attempt=0,this._lifecycle(s.LOADED,i,t)},()=>{var e;this.options.attempt&&this.attempt<this.options.attempt?(this.attempt+=1,t.setAttribute("src",r),this._log(()=>{this._logger(`load failed, retry: ${r}; attempt: `+this.attempt)})):(t.onload=null,this._lifecycle(s.ERROR,i,t),null!=(e=this._realObserver(t))&&e.disconnect(),o&&t.getAttribute("src")!==o&&t.setAttribute("src",o),this._log(()=>{this._logger(`Image failed to load!And failed src was: ${r} `)}),this.attempt=0)})):t.style.backgroundImage=`url('${r}')`}_initIntersectionObserver(t,r,o,i,n){var e=this.options.observerOptions;this._images.set(t,new IntersectionObserver(e=>{Array.prototype.forEach.call(e,e=>{n&&0<n?this._delayedIntersectionCallback(t,e,n,r,o,i):this._intersectionCallback(t,e,r,o,i)})},e)),null!=(e=this._realObserver(t))&&e.observe(t)}_intersectionCallback(e,t,r,o,i){var n;t.isIntersecting&&(null!=(n=this._realObserver(e))&&n.unobserve(t.target),this._setImageSrc(e,r,o,i))}_delayedIntersectionCallback(e,t,r,o,i,n){t.isIntersecting?t.target.hasAttribute(c)||(r=setTimeout(()=>{this._intersectionCallback(e,t,o,i,n),t.target.removeAttribute(c)},r),t.target.setAttribute(c,String(r))):t.target.hasAttribute(c)&&(clearTimeout(Number(t.target.getAttribute(c))),t.target.removeAttribute(c))}_listenImageStatus(e,t,r){e.onload=t,e.onerror=r}_valueFormatter(e){let t=e,r=this.options.loading,o=this.options.error,i=this.options.lifecycle,n=this.options.delay;return g(e)&&(t=e.src,r=e.loading||this.options.loading,o=e.error||this.options.error,i=e.lifecycle||this.options.lifecycle,n=e.delay||this.options.delay),{src:t,loading:r,error:o,lifecycle:i,delay:n}}_log(e){this.options.log&&e()}_lifecycle(e,t,r){switch(e){case s.LOADING:null!=r&&r.setAttribute("lazy",s.LOADING),null!=t&&t.loading&&t.loading(r);break;case s.LOADED:null!=r&&r.setAttribute("lazy",s.LOADED),null!=t&&t.loaded&&t.loaded(r);break;case s.ERROR:null!=r&&r.setAttribute("lazy",s.ERROR),null!=t&&t.error&&t.error(r)}}_realObserver(e){return this._images.get(e)}_logger(e,...t){let r=console.error;switch(this.options.logLevel){case"error":r=console.error;break;case"warn":r=console.warn;break;case"info":r=console.info;break;case"debug":r=console.debug}r(e,t)}}e.default={install(e,t){const r=new n(t);e.config.globalProperties.$Lazyload=r,e.provide("Lazyload",r),e.directive("lazy",{mounted:r.mount.bind(r),updated:r.update.bind(r),unmounted:r.unmount.bind(r)})}},e.useLazyload=function(t,e){const r=i.ref(null),o=new n(e);return i.onMounted(()=>{r.value&&o.mount(r.value,t.value)}),i.onUnmounted(()=>{r.value&&o.unmount(r.value)}),i.watch(t,e=>{t.value&&o.update(r.value,e)}),r},Object.defineProperty(e,"__esModule",{value:!0})});
